<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GPS → ThingSpeak</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f5f6fa; }
    header { padding: 1rem; text-align: center; background: #004080; color: white; }
    h1 { margin: 0; font-size: 1.5rem; }
    .controls { text-align: center; margin: 1rem 0; }
    .btn {
      padding: .6rem 1rem;
      border: none;
      border-radius: 6px;
      margin: 0 .3rem;
      cursor: pointer;
      font-weight: bold;
    }
    .btn.start { background: #2563eb; color: white; }
    .btn.stop { background: #ccc; }
    #map { height: 420px; margin: 1rem auto; width: 95%; border-radius: 8px; }
    .status { text-align: center; font-size: .95rem; margin-top: .5rem; }
  </style>
</head>
<body>

<header>
  <h1>GPS → ThingSpeak Uploader</h1>
</header>

<div class="controls">
  <button id="startBtn" class="btn start">Start GPS</button>
  <button id="stopBtn" class="btn stop">Stop GPS</button>
</div>

<div id="map"></div>
<div class="status">
  <span id="latDisp">Lat: —</span> | <span id="lonDisp">Lon: —</span>
</div>

<script>
const ESP32_IP = "10.229.188.187"; // your ESP32's IP
let watchId = null;
let map, marker;

function initMap() {
  map = L.map('map').setView([0,0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
}

function sendLocation(lat, lon) {
  fetch(`http://${ESP32_IP}/location`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ lat: lat, lon: lon })
  }).then(r => r.text()).then(console.log).catch(console.error);
}

function startGPS() {
  if (!navigator.geolocation) {
    alert("Geolocation not supported by your browser.");
    return;
  }
  watchId = navigator.geolocation.watchPosition(pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    document.getElementById('latDisp').textContent = `Lat: ${lat.toFixed(6)}`;
    document.getElementById('lonDisp').textContent = `Lon: ${lon.toFixed(6)}`;

    // Update map
    if (!marker) {
      marker = L.marker([lat, lon]).addTo(map);
    } else {
      marker.setLatLng([lat, lon]);
    }
    map.setView([lat, lon], 16);

    // Send to ESP32 for ThingSpeak upload
    sendLocation(lat, lon);

  }, err => {
    console.error(err);
    alert("Error getting GPS location.");
  }, { enableHighAccuracy: true });
}

function stopGPS() {
  if (watchId !== null) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
    fetch(`http://${ESP32_IP}/stopLocation`, { method: "POST" })
      .then(r => r.text()).then(console.log).catch(console.error);
  }
}

document.getElementById('startBtn').addEventListener('click', startGPS);
document.getElementById('stopBtn').addEventListener('click', stopGPS);

initMap();
</script>

</body>
</html>
