<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>GPS → ThingSpeak (Auto-Parity) + Merge Viewer + AQI/Speed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;padding:1rem;background:#f6f7fb;color:#111}
    h1{margin:.2rem 0 .4rem}
    #map{height:380px;border-radius:10px;margin:10px 0;background:#e9eef5}
    .row{display:flex;flex-wrap:wrap;gap:1rem}
    .col{flex:1 1 340px;background:#fff;border-radius:12px;box-shadow:0 8px 18px rgba(0,0,0,.08);padding:1rem}
    .btn{padding:.6rem 1rem;border:0;border-radius:8px;cursor:pointer;font-weight:600}
    .primary{background:#2563eb;color:#fff}
    .ghost{background:#e5e7eb}
    .ok{color:#16a34a}.warn{color:#f59e0b}.err{color:#ef4444}.muted{color:#6b7280}
    table{width:100%;border-collapse:collapse;font-size:.95rem}
    th,td{border:1px solid #e5e7eb;padding:.45rem .5rem}
    th{background:#f3f4f6;text-align:left}
    .controls label{display:block;font-size:.9rem;margin:.4rem 0 .2rem}
    .controls input{width:100%;padding:.45rem .5rem;border:1px solid #d1d5db;border-radius:8px}
    .small{font-size:.9rem}
  </style>
</head>
<body>
  <!-- Header -->
<header>
  <div class="header-layout">
    <div class="logo-container">
      <img src="images/dcu_logo.jpg" class="dcu-logo-left" alt="DCU Logo" />
    </div>
    <div class="header-content">
      <h1>Car Portable Urban Air Quality Monitor</h1>
      <p class="tagline">Live CO₂, PM, RH/Temp via ThingSpeak + GPS (opt-in)</p>
      <p class="author">Lauren Dwyer | Student No. 38529 | MECE1</p>
    </div>
  </div>
</header>

  <nav class="topnav">
  <ul>
    <li><a href="#" onclick="showSection('sensor-overview')" class="navlink active">Sensor Overview</a></li>
    <li><a href="#" onclick="showSection('hardware')" class="navlink">Hardware</a></li>
    <li><a href="#" onclick="showSection('enclosure')" class="navlink">Enclosure & Mounting</a></li>
    <li><a href="#" onclick="showSection('deployment')" class="navlink">Deployment</a></li>
  </ul>
</nav>

  <!-- Sensor Section -->
<section id="sensor-overview">
  <h1>Sensor Overview</h2>
<h2>GPS → ThingSpeak + Auto-Parity + Merged Table (AQI + Speed)</h1>
  
<p class="small">
  Status: <span id="status" class="muted">Idle</span> •
  Parity: <span id="parity" class="muted">odd (auto)</span> •
  Align: <span id="align" class="muted">waiting</span>
</p>

<div class="row">
  <div class="col">
    <div style="display:flex;gap:.5rem;flex-wrap:wrap">
      <button class="btn primary" id="startBtn">Start GPS Upload</button>
      <button class="btn ghost" id="stopBtn">Stop</button>
    </div>
    <div id="map"></div>
    <p class="muted small" style="margin:.2rem 0 0">
      Writes: field7=Latitude, field8=Longitude • slot = <span id="slot">—</span>
    </p>
    <div class="controls" style="margin-top:.75rem">
      <label>Channel ID</label>
      <input id="chId" value="2960675" />
      <label>Read API Key (blank if public)</label>
      <input id="readKey" value="" />
      <label class="small">Slot length (ms)</label>
      <input id="slotLen" type="number" value="40000" />
    </div>
  </div>

  <div class="col">
    <h3>Fetch & Merge</h3>
    <div class="controls">
      <label>How many latest rows</label>
      <input id="results" type="number" value="200" />
      <label>Merge window (seconds)</label>
      <input id="window" type="number" value="90" />
    </div>
    <p style="margin:.6rem 0">
      <button class="btn primary" id="fetchBtn">Fetch & Merge</button>
      <button class="btn ghost" id="dlBtn" disabled>Download CSV</button>
    </p>
    <div id="mergeStatus" class="muted">Waiting…</div>
    <div style="max-height:340px;overflow:auto;margin-top:.5rem">
      <table id="tbl"></table>
    </div>
  </div>
</div>
  <label for="sensorSelect"><strong>View by Sensor:</strong></label>
  <select id="sensorSelect" onchange="handleSensorSelect(this.value)">
    <option value="none">-- Select --</option>
    <option value="scd30">SCD30 (CO₂, Temp, RH)</option>
    <option value="sps30">SPS30 (PM1.0, PM2.5, PM10)</option>
    <option value="mics">MiCS-4514 (NO₂)</option>
  </select>

  <div class="tabs">
    <button class="tablink" onclick="showTab('co2', this)">CO₂</button>
    <button class="tablink" onclick="showTab('pm25', this)">PM2.5</button>
    <button class="tablink" onclick="showTab('pm10', this)">PM10</button>
    <button class="tablink" onclick="showTab('pm1', this)">PM1.0</button>
    <button class="tablink" onclick="showTab('temp', this)">Temp</button>
    <button class="tablink" onclick="showTab('rh', this)">Humidity</button>
  </div>

  <div id="sensorTabs" class="tab-group">
    <div id="co2" class="tabcontent tab-box">
      <p><strong>Latest CO₂:</strong> <span id="co2val">Loading...</span> ppm</p>
      <iframe src="https://thingspeak.com/channels/2960675/charts/4?dynamic=true&w=1000&h=400"></iframe>
    </div>

    <div id="pm25" class="tabcontent tab-box">
      <p><strong>Latest PM2.5:</strong> <span id="pm25val">Loading...</span> µg/m³</p>
      <iframe src="https://thingspeak.com/channels/2960675/charts/2?dynamic=true&w=1000&h=400"></iframe>
    </div>

    <div id="pm10" class="tabcontent tab-box">
      <p><strong>Latest PM10:</strong> <span id="pm10val">Loading...</span> µg/m³</p>
      <iframe src="https://thingspeak.com/channels/2960675/charts/3?dynamic=true&w=1000&h=400"></iframe>
    </div>

    <div id="pm1" class="tabcontent tab-box">
      <p><strong>Latest PM1.0:</strong> <span id="pm1val">Loading...</span> µg/m³</p>
      <iframe src="https://thingspeak.com/channels/2960675/charts/1?dynamic=true&w=1000&h=400"></iframe>
    </div>

    <div id="temp" class="tabcontent tab-box">
      <p><strong>Latest Temp:</strong> <span id="tempval">Loading...</span> °C</p>
      <iframe src="https://thingspeak.com/channels/2960675/charts/5?dynamic=true&w=1000&h=400"></iframe>
    </div>

    <div id="rh" class="tabcontent tab-box">
      <p><strong>Latest Humidity:</strong> <span id="humval">Loading...</span> %</p>
      <iframe src="https://thingspeak.com/channels/2960675/charts/6?dynamic=true&w=1000&h=400"></iframe>
    </div>

  </div>
</section>

<!-- Hardware Section -->
<section id="hardware">
  <h2>Hardware Overview</h2>
  <p>This system uses the following components:</p>
  <ul>
    <li><a href="https://docs.espressif.com/projects/esp-dev-kits/en/latest/esp32/esp32-devkitc/user_guide.html" target="_blank">ESP32-DEVKITC-VE</a></li>
    <li><a href="https://sensirion.com/media/documents/4EAF6AF8/61652C3C/Sensirion_CO2_Sensors_SCD30_Datasheet.pdf" target="_blank">SCD30: CO₂, Temperature, Humidity</a></li>
    <li><a href="https://sensirion.com/media/documents/B7AAA101/61653FB8/Sensirion_Particulate_Matter_AppNotes_Specification_Statement.pdf" target="_blank">SPS30: PM1.0, PM2.5, PM10</a></li>
    <li><a href="https://www.sgxsensortech.com/content/uploads/2014/08/0278_Datasheet-MiCS-4514.pdf" target="_blank">MiCS-4514: NO₂</a></li>
    <li><a href="https://www.analog.com/media/en/technical-documentation/data-sheets/ds3231.pdf" target="_blank">DS3231 RTC</a></li>
    <li>MicroSD Card Module</li>
    <li><a href="https://www.handsontec.com/dataspecs/I2C_2004_LCD.pdf" target="_blank">LCD Display</a></li>
    <li><a href="https://www.aliexpress.com/item/1005007835418978.html" target="_blank">Li-Ion Battery Pack</a></li>
  </ul>
</section>

<section id="enclosure">
  <h2>Enclosure & Mounting</h2>
  <p>Weatherproof enclosure with airflow slots; roof-mounted using suction + straps.</p>
</section>

<section id="deployment">
  <h2>Deployment</h2>
  <p>Uploaded every 30 seconds to <a href="https://thingspeak.mathworks.com/channels/2960675" target="_blank">ThingSpeak</a>, Blynk, and microSD during July/August 2025 trials.</p>
</section>
  
<script>
const THINGSPEAK_WRITE_KEY = "9YXHS30JF6Z9YHXI";
const THINGSPEAK_UPDATE_URL = "https://api.thingspeak.com/update.json";

const $ = s => document.querySelector(s);
function setStatus(msg, cls='muted'){ const el=$("#status"); el.className=cls; el.textContent=msg; }
function setParityLabel(p){ $("#parity").textContent = p===1 ? "odd" : "even"; }
function setAlign(msg, cls='muted'){ const el=$("#align"); el.className=cls; el.textContent=msg; }

let map = L.map('map').setView([53.35, -6.26], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);
let marker;

let SLOT_MS = parseInt($("#slotLen").value,10) || 40000;
$("#slotLen").addEventListener('change', ()=>{ SLOT_MS = parseInt($("#slotLen").value,10) || 40000; });

let gpsWatchId = null;
let lastLat = null, lastLon = null;
let slotTimer = null;
let lastSlotSent = -1;
let gpsParity = 1;
let autoAligned = false;
let mismatchCount = 0;
const MIS_MATCH_TO_FLIP = 2;
const currentSlot = () => Math.floor(Date.now() / SLOT_MS);

async function readChannelFeeds(channelId, readKey, results=40) {
  const base = `https://api.thingspeak.com/channels/${channelId}/feeds.json`;
  const u = new URL(base);
  if (readKey) u.searchParams.set('api_key', readKey);
  u.searchParams.set('results', results);
  const r = await fetch(u, {cache:'no-store'});
  if (!r.ok) throw new Error(`TS read HTTP ${r.status}`);
  const j = await r.json();
  return j.feeds.map(f => ({
    created_at: f.created_at,
    ts: new Date(f.created_at).getTime(),
    pm1: parseFloat(f.field1) || null,
    pm25: parseFloat(f.field2) || null,
    pm10: parseFloat(f.field3) || null,
    co2: parseFloat(f.field4) || null,
    temp: parseFloat(f.field5) || null,
    hum: parseFloat(f.field6) || null,
    lat: parseFloat(f.field7),
    lon: parseFloat(f.field8)
  }));
}

function isSensorRow(r){ return [r.pm1,r.pm25,r.pm10,r.co2,r.temp,r.hum].some(v => typeof v === 'number' && !Number.isNaN(v)); }
function isGpsRow(r){ return Number.isFinite(r.lat) && Number.isFinite(r.lon); }

function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2-lat1) * Math.PI/180;
  const dLon = (lon2-lon1) * Math.PI/180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); // km
}

function calcAQIpm25(pm) {
  const bp = [
    {cLow:0.0, cHigh:12.0, aqiLow:0, aqiHigh:50},
    {cLow:12.1, cHigh:35.4, aqiLow:51, aqiHigh:100},
    {cLow:35.5, cHigh:55.4, aqiLow:101, aqiHigh:150},
    {cLow:55.5, cHigh:150.4, aqiLow:151, aqiHigh:200},
    {cLow:150.5, cHigh:250.4, aqiLow:201, aqiHigh:300},
    {cLow:250.5, cHigh:500.4, aqiLow:301, aqiHigh:500}
  ];
  for (let i of bp) {
    if (pm >= i.cLow && pm <= i.cHigh) {
      return Math.round(((i.aqiHigh - i.aqiLow)/(i.cHigh - i.cLow)) * (pm - i.cLow) + i.aqiLow);
    }
  }
  return null;
}

function mergeSameChannel(rows, windowSec){
  const W = windowSec * 1000;
  const sensors = rows.filter(isSensorRow);
  const gps = rows.filter(isGpsRow);

  const out = [];
  let prevLat = null, prevLon = null, prevTime = null;

  for (const s of sensors) {
    let best = null, bestDt = Infinity;
    for (const g of gps) {
      const dt = Math.abs(s.ts - g.ts);
      if (dt < bestDt && dt <= W) { best = g; bestDt = dt; }
    }
    if (best && Number.isFinite(best.lat) && Number.isFinite(best.lon)) {
      let speed = null;
      if (prevLat != null && prevLon != null && prevTime != null) {
        const distKm = haversine(prevLat, prevLon, best.lat, best.lon);
        const dtHr = (s.ts - prevTime) / 3600000;
        if (dtHr > 0) speed = +(distKm / dtHr).toFixed(1);
      }
      const aqi = (() => {
        let base = calcAQIpm25(s.pm25);
        if (s.co2 > 1000) base += 5;
        if (s.co2 > 2000) base += 15;
        return base;
      })();
      out.push({
        created_at: s.created_at,
        pm1: s.pm1 ?? '', pm25: s.pm25 ?? '', pm10: s.pm10 ?? '',
        co2: s.co2 ?? '', temp: s.temp ?? '', hum: s.hum ?? '',
        lat: best.lat, lon: best.lon,
        dt_s: Math.round(bestDt/1000),
        speed_kmh: speed ?? '',
        aqi: aqi ?? ''
      });
      prevLat = best.lat; prevLon = best.lon; prevTime = s.ts;
    }
  }
  return out;
}

function renderTable(rows){
  if (!rows.length) { $("#tbl").innerHTML = '<tr><td>No merged rows</td></tr>'; return; }
  const cols = ['created_at','pm1','pm25','pm10','co2','temp','hum','lat','lon','dt_s','speed_kmh','aqi'];
  $("#tbl").innerHTML =
    '<thead><tr>' + cols.map(c=>`<th>${c}</th>`).join('') + '</tr></thead>' +
    '<tbody>' + rows.map(r => '<tr>' +
      cols.map(c => `<td>${(r[c] ?? '')}</td>`).join('') +
    '</tr>').join('') + '</tbody>';
}

async function postToThingSpeak(lat, lon){
  try {
    const body = new URLSearchParams({api_key: THINGSPEAK_WRITE_KEY, field7: lat, field8: lon});
    const r = await fetch(THINGSPEAK_UPDATE_URL, {method: 'POST', headers: {'Content-Type':'application/x-www-form-urlencoded'}, body});
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const entryId = await r.json();
    if (+entryId === 0) { setStatus('TS rejected GPS', 'err'); return 0; }
    setStatus(`GPS uploaded: ${lat.toFixed(6)}, ${lon.toFixed(6)}`, 'ok');
    return +entryId;
  } catch(e){ setStatus(`Upload error: ${e.message}`, 'err'); return 0; }
}

async function trySlotUpload(){
  if (lastLat == null || lastLon == null) return;
  const slot = currentSlot();
  $("#slot").textContent = String(slot);
  if (slot === lastSlotSent) return;
  if ((slot % 2) !== gpsParity) return;
  await new Promise(res => setTimeout(res, 200));
  const id = await postToThingSpeak(lastLat, lastLon);
  if (id > 0) lastSlotSent = slot;
}

$("#startBtn").addEventListener('click', () => {
  if (!navigator.geolocation) { alert('Geolocation not supported'); return; }
  if (gpsWatchId) { setStatus('Already running', 'warn'); return; }
  gpsWatchId = navigator.geolocation.watchPosition(pos => {
    lastLat = pos.coords.latitude;
    lastLon = pos.coords.longitude;
    if (marker) marker.setLatLng([lastLat, lastLon]);
    else marker = L.marker([lastLat, lastLon]).addTo(map);
    map.setView([lastLat, lastLon], 15);
    trySlotUpload();
    if (!slotTimer) slotTimer = setInterval(trySlotUpload, 1000);
  }, err => setStatus(`GPS error: ${err.message}`, 'err'), { enableHighAccuracy:true });
});

$("#stopBtn").addEventListener('click', () => {
  if (gpsWatchId) { navigator.geolocation.clearWatch(gpsWatchId); gpsWatchId = null; }
  if (slotTimer) { clearInterval(slotTimer); slotTimer = null; }
  setStatus('Stopped', 'muted');
});

let lastMerged = []; // store last merge result
let lastCols = ['created_at','pm1','pm25','pm10','co2','temp','hum','lat','lon','dt_s','speed_kmh','aqi'];

$("#fetchBtn").addEventListener('click', async () => {
  const chId = $("#chId").value.trim();
  const readKey = $("#readKey").value.trim();
  const results = parseInt($("#results").value || '200', 10);
  const windowSec = parseInt($("#window").value || '90', 10);
  try {
    $("#mergeStatus").textContent = 'Fetching…';
    const rows = await readChannelFeeds(chId, readKey, results);
    $("#mergeStatus").textContent = 'Merging…';
    lastMerged = mergeSameChannel(rows, windowSec);
    renderTable(lastMerged);
    $("#dlBtn").disabled = lastMerged.length === 0;
    $("#mergeStatus").textContent = `Merged ${lastMerged.length} rows`;
  } catch (e) {
    $("#mergeStatus").textContent = `Error: ${e.message}`;
  }
});

$("#dlBtn").addEventListener('click', () => {
  if (!lastMerged.length) return;
  const lines = [lastCols.join(',')].concat(lastMerged.map(r => lastCols.map(c => r[c]).join(',')));
  const blob = new Blob([lines.join('\n')], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'merged_thingspeak.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

</script>
</body>
</html>
