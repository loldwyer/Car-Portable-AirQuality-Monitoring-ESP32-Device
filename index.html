<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>GPS → ThingSpeak (Auto-Parity) + Merge Viewer + AQI/Speed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="style.css">
  
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="app.js" defer></script>
  
    
</head>
<body>
  <!-- Header -->
<header>
  <div class="header-layout">
    <div class="logo-container">
      <img src="images/dcu_logo.jpg" class="dcu-logo-left" alt="DCU Logo" />
    </div>
    <div class="header-content">
      <h1>Car Portable Urban Air Quality Monitor</h1>
      <p class="tagline">Live CO₂, PM, RH/Temp via ThingSpeak + GPS (opt-in)</p>
      <p class="author">Lauren Dwyer | Student No. 38529 | MECE1</p>
    </div>
  </div>
</header>

  <nav class="topnav">
  <ul>
    <li><a href="#" onclick="event.preventDefault(); showSection('sensor-overview')" class="navlink active">Sensor Overview</a></li>
    <li><a href="#" onclick="event.preventDefault(); showSection('hardware')" class="navlink">Hardware</a></li>
    <li><a href="#" onclick="event.preventDefault(); showSection('enclosure')" class="navlink">Enclosure & Mounting</a></li>
    <li><a href="#" onclick="event.preventDefault(); showSection('deployment')" class="navlink">Deployment</a></li>
  </ul>
</nav>

  <!-- Sensor Section -->
<section id="sensor-overview">
<h1>GPS → ThingSpeak + Auto-Parity + Merged Table (AQI + Speed)</h1>
  <p>Sensor data is continously sent from ESP32 to Thingspeak. Press the 'Start GPS Upload' button to allow device tracking and the sending of device data to Thingspeak.
  <li>This GPS data will be 'merged' with the sensor data using the 'Fetch&Merge' button below </li>
    <li>Once merged the data can be viewed in this browser or downloaded in .csv format for sanalysis</li>
<li>Thingspeak graphs can be viewed in this Sensor Overview section or on <a href="https://thingspeak.mathworks.com/channels/2960675"> ThingSpeak itself</a></li>  </p>


<div class="row">
  <div class="col">
     <h3>GPS Permission</h3> 
<p class="small">
  Status: <span id="status" class="muted">Idle</span> •
  Parity: <span id="parity" class="muted">odd (auto)</span> •
  Align: <span id="align" class="muted">waiting</span>
</p>
    <div style="display:flex;gap:.5rem;flex-wrap:wrap">
      <button class="btn primary" id="startBtn">Start GPS Upload</button>
      <button class="btn ghost" id="stopBtn">Stop</button>
    </div>
    <div id="map"></div>
    <p class="muted small" style="margin:.2rem 0 0">
      Writes: field7=Latitude, field8=Longitude • slot = <span id="slot">—</span>
    </p>
    <div class="controls" style="margin-top:.75rem">
      <label>Channel ID (unchangeable)</label>
      <input id="chId" value="2960675" />
      <label>Read API Key (blank if public)</label>
      <input id="readKey" value="" />
      <label class="small">Slot length (ms)</label>
      <input id="slotLen" type="number" value="40000" />
    </div>
  </div>

  <div class="col">
    <h3>Fetch & Merge</h3>
    <div class="controls">
      <label>How many latest rows</label>
      <input id="results" type="number" value="200" />
      <label>Merge window (seconds)</label>
      <input id="window" type="number" value="90" />
    </div>
    <p style="margin:.6rem 0">
      <button class="btn primary" id="fetchBtn">Fetch & Merge</button>
      <button class="btn ghost" id="dlBtn" disabled>Download CSV</button>
    </p>
    <div id="mergeStatus" class="muted">Waiting…</div>
    <div style="max-height:340px;overflow:auto;margin-top:.5rem">
      <table id="tbl"></table>
    </div>
  </div>
</div>

<h2>ThingSpeak Visualisations</h2>
    <label for="sensorSelect"><strong>View by Sensor:</strong></label>
  <select id="sensorSelect" onchange="handleSensorSelect(this.value)">
    <option value="none">-- Select --</option>
    <option value="scd30">SCD30 (CO₂, Temp, RH)</option>
    <option value="sps30">SPS30 (PM1.0, PM2.5, PM10)</option>
    <option value="mics">MiCS-4514 (NO₂)</option>
  </select>
  <div class="tabs">
    <button class="tablink" onclick="showTab('co2', this)">CO₂</button>
    <button class="tablink" onclick="showTab('pm25', this)">PM2.5</button>
    <button class="tablink" onclick="showTab('pm10', this)">PM10</button>
    <button class="tablink" onclick="showTab('pm1', this)">PM1.0</button>
    <button class="tablink" onclick="showTab('temp', this)">Temp</button>
    <button class="tablink" onclick="showTab('rh', this)">Humidity</button>
  </div>

  <div id="sensorTabs" class="tab-group">
    <div id="co2" class="tabcontent tab-box">
      <p><strong>Latest CO₂:</strong> <span id="co2val">Loading...</span> ppm</p>
      <iframe src="https://thingspeak.com/channels/2960675/charts/4?dynamic=true&w=1000&h=400"></iframe>
    </div>

    <div id="pm25" class="tabcontent tab-box">
      <p><strong>Latest PM2.5:</strong> <span id="pm25val">Loading...</span> µg/m³</p>
      <iframe src="https://thingspeak.com/channels/2960675/charts/2?dynamic=true&w=1000&h=400"></iframe>
    </div>

    <div id="pm10" class="tabcontent tab-box">
      <p><strong>Latest PM10:</strong> <span id="pm10val">Loading...</span> µg/m³</p>
      <iframe src="https://thingspeak.com/channels/2960675/charts/3?dynamic=true&w=1000&h=400"></iframe>
    </div>

    <div id="pm1" class="tabcontent tab-box">
      <p><strong>Latest PM1.0:</strong> <span id="pm1val">Loading...</span> µg/m³</p>
      <iframe src="https://thingspeak.com/channels/2960675/charts/1?dynamic=true&w=1000&h=400"></iframe>
    </div>

    <div id="temp" class="tabcontent tab-box">
      <p><strong>Latest Temp:</strong> <span id="tempval">Loading...</span> °C</p>
      <iframe src="https://thingspeak.com/channels/2960675/charts/5?dynamic=true&w=1000&h=400"></iframe>
    </div>

    <div id="rh" class="tabcontent tab-box">
      <p><strong>Latest Humidity:</strong> <span id="humval">Loading...</span> %</p>
      <iframe src="https://thingspeak.com/channels/2960675/charts/6?dynamic=true&w=1000&h=400"></iframe>
    </div>

  </div>
</section>

<!-- Hardware Section -->
<section id="hardware">
  <h2>Hardware Overview</h2>
  <p>This system uses the following components:</p>
  <ul>
    <li><a href="https://docs.espressif.com/projects/esp-dev-kits/en/latest/esp32/esp32-devkitc/user_guide.html" target="_blank">ESP32-DEVKITC-VE</a></li>
    <li><a href="https://sensirion.com/media/documents/4EAF6AF8/61652C3C/Sensirion_CO2_Sensors_SCD30_Datasheet.pdf" target="_blank">SCD30: CO₂, Temperature, Humidity</a></li>
    <li><a href="https://sensirion.com/media/documents/B7AAA101/61653FB8/Sensirion_Particulate_Matter_AppNotes_Specification_Statement.pdf" target="_blank">SPS30: PM1.0, PM2.5, PM10</a></li>
    <li><a href="https://www.sgxsensortech.com/content/uploads/2014/08/0278_Datasheet-MiCS-4514.pdf" target="_blank">MiCS-4514: NO₂</a></li>
    <li><a href="https://www.analog.com/media/en/technical-documentation/data-sheets/ds3231.pdf" target="_blank">DS3231 RTC</a></li>
    <li>MicroSD Card Module</li>
    <li><a href="https://www.handsontec.com/dataspecs/I2C_2004_LCD.pdf" target="_blank">LCD Display</a></li>
    <li><a href="https://www.aliexpress.com/item/1005007835418978.html" target="_blank">Li-Ion Battery Pack</a></li>
  </ul>
  <img src="images/fritzing.png" alt="Fritzing Diagram" />
</section>

<section id="enclosure">
  <h2>Enclosure & Mounting</h2>

  <h3>Enclosure</h3>
  <p>
    Electronics are housed in a water-resistant plastic lunchbox with two dedicated inlets
    positioned directly over the SPS30 and SCD30. Each inlet is covered by a small,
    downward-facing hood (cut from a plastic drinks bottle) to promote ambient airflow while
    shedding rain and spray. The enclosure exterior is wrapped in aluminium foil tape,
    which reduced solar heating and eliminated missed reads observed during early tests.
  </p>
  <ul>
    <li>Weather protection: downward hoods + enclosure lip to minimize water ingress.</li>
    <li>Thermal control: reflective foil tape to limit internal temperature rise.</li>
    <li>Layout: sensors placed near inlets; cabling strain-relieved; SD card and lithium battery accessible.</li>
  </ul>

  <h3>Airflow orientation</h3>
  <p>
    Inlets are oriented cross-wind with the hoods angled slightly downward. This reduces splash entry, 
    and improves representativeness of ambient air over the roof. The unit is mounted away from the exhaust path of its vehicle and other vehicles on the road.
  </p>

  <h3>Mounting</h3>
  <p>
    The enclosure is secured on the vehicle roof using a high-strength magnet (from a trailer-light
    mount) plus two suction cups; bungee straps across the lid provide redundancy.
    This configuration remained stable at motorway speeds (tested up to ~120&nbsp;km/h) and
    maintained consistent airflow to the sensor inlets.
  </p>
  <ul>
    <li>Primary retention: magnet base on roof centreline.</li>
    <li>Secondary retention: two suction cups + crossed bungee straps.</li>
  </ul>

  <h3>Pre-drive checks</h3>
  <ul>
    <li>“Tug test” on magnet/suction fittings; verify bungee tension.</li>
    <li>Confirm hoods are dry/clear and not obstructed.</li>
    <li>Power-on self-check (Blynk/ThingSpeak live values; SD logging active).</li>
  </ul>

  <img src="images/enc_mounted.jpg" alt="MountedEnclosure" />
</section>


<section id="deployment">
    <h2>Deployment</h2>
  <p>
    Sensors sampled every <strong>5&nbsp;s</strong>. During the July/August 2025 trials we logged to microSD and
    uploaded to <a href="https://thingspeak.mathworks.com/channels/2960675" target="_blank" rel="noopener">ThingSpeak</a> and Blynk.
    Cloud uploads used even/odd 40&nbsp;s slots (sensors vs GPS), giving an effective merged cadence of ~<strong>80&nbsp;s</strong>.
    View the results of each test on Google Maps by expanding the map below:
  </p>

  <iframe src="https://www.google.com/maps/d/u/0/embed?mid=1rI7wFu2_4CdTrDXsANYUR-grH3z8uUE&ehbc=2E312F" width="640" height="480"></iframe>

  <h3>Test 1 — Tue 12 Aug (Laois → Dublin, one-way)</h3>
  <ul>
    <li><strong>Peak AQI & GPS:</strong> Highest AQI values (&gt;80) near Junction&nbsp;14 (busy interchange).</li>
    <li><strong>Lowest AQI & GPS:</strong> Rural sections near J16 (Laois) and after exiting J13 (Kildare).</li>
    <li><strong>PM vs CO₂:</strong> Peaks do not always coincide; high CO₂ can occur with low PM.</li>
    <li><strong>Speed:</strong> Some elevated PM at motorway speeds (&gt;100&nbsp;km/h).</li>
    <li><strong>Conditions:</strong> On-board ~24–37&nbsp;°C, RH ~20–57%; several high-AQI periods coincided with RH&nbsp;&gt;55% and lower temps.</li>
  </ul>

  <h3>Test 2 — Wed 6 Aug (Round trip)</h3>
  <ul>
    <li><strong>Overall levels:</strong> Lower PM than Test&nbsp;1; baseline ~2–6&nbsp;µg/m³ with peaks ~10–12&nbsp;µg/m³ near Dublin.</li>
    <li><strong>Hotspots:</strong> Short-lived, location-specific PM spikes at junctions/bottlenecks detected on-road.</li>
    <li><strong>PM vs CO₂:</strong> CO₂ generally 150–250&nbsp;ppm with peaks at traffic bottlenecks; PM and CO₂ peaks often decoupled.</li>
    <li><strong>Pairing:</strong> Sensor–GPS merge by nearest timestamp (≤90&nbsp;s); points shown are single, unaveraged measurements.</li>
  </ul>

  <h3>Test 3 — Wed 13 Aug (Round trip, same weekday one week later)</h3>
  <ul>
    <li><strong>Repeatability:</strong> PM₂.₅ profile closely matches Test&nbsp;2 (baseline ~2–6&nbsp;µg/m³; peaks ~10–12&nbsp;µg/m³ near Dublin).</li>
    <li><strong>Hotspots:</strong> Similar spatial peaks to Test&nbsp;2, reinforcing junction/bottleneck effects.</li>
    <li><strong>PM vs CO₂:</strong> CO₂ behaviour similar to Test&nbsp;2; moderate rises at congestion, not always aligned with PM.</li>
    <li><strong>Conditions:</strong> On-board ~21–36&nbsp;°C, RH ~32–67%; consistent with late-afternoon/early-evening runs.</li>
  </ul>

  <p><em>Note:</em> Some nearby fixed stations were inactive on our dates (e.g., Ballymun Library, Emo), so fixed–mobile comparisons were performed only where fixed data were available.</p>
</section>


</body>
</html>
