<!-- Sensor Section (enhanced) -->
<section id="sensor-overview">
  <h2>Sensor Overview</h2>

  <label for="sensorSelect"><strong>View by Sensor:</strong></label>
  <select id="sensorSelect" onchange="handleSensorSelect(this.value)">
    <option value="none">-- Select --</option>
    <option value="scd30">SCD30 (CO₂, Temp, RH)</option>
    <option value="sps30">SPS30 (PM1.0, PM2.5, PM10)</option>
    <option value="mics">MiCS-4514 (NO₂)</option>
  </select>

  <div class="tabs" style="margin-top:.5rem">
    <button class="tablink" onclick="showTab('co2', this)">CO₂</button>
    <button class="tablink" onclick="showTab('pm25', this)">PM2.5</button>
    <button class="tablink" onclick="showTab('pm10', this)">PM10</button>
    <button class="tablink" onclick="showTab('pm1', this)">PM1.0</button>
    <button class="tablink" onclick="showTab('temp', this)">Temp</button>
    <button class="tablink" onclick="showTab('rh', this)">Humidity</button>
  </div>

  <div id="sensorTabs" class="tab-group">
    <div id="co2" class="tabcontent tab-box">
      <p><strong>Latest CO₂:</strong> <span id="co2val">Loading...</span> ppm</p>
      <iframe src="https://thingspeak.com/channels/2960675/charts/4?dynamic=true&w=1000&h=400"></iframe>
    </div>

    <div id="pm25" class="tabcontent tab-box" style="display:none">
      <p><strong>Latest PM2.5:</strong> <span id="pm25val">Loading...</span> µg/m³</p>
      <iframe src="https://thingspeak.com/channels/2960675/charts/2?dynamic=true&w=1000&h=400"></iframe>
    </div>

    <div id="pm10" class="tabcontent tab-box" style="display:none">
      <p><strong>Latest PM10:</strong> <span id="pm10val">Loading...</span> µg/m³</p>
      <iframe src="https://thingspeak.com/channels/2960675/charts/3?dynamic=true&w=1000&h=400"></iframe>
    </div>

    <div id="pm1" class="tabcontent tab-box" style="display:none">
      <p><strong>Latest PM1.0:</strong> <span id="pm1val">Loading...</span> µg/m³</p>
      <iframe src="https://thingspeak.com/channels/2960675/charts/1?dynamic=true&w=1000&h=400"></iframe>
    </div>

    <div id="temp" class="tabcontent tab-box" style="display:none">
      <p><strong>Latest Temp:</strong> <span id="tempval">Loading...</span> °C</p>
      <iframe src="https://thingspeak.com/channels/2960675/charts/5?dynamic=true&w=1000&h=400"></iframe>
    </div>

    <div id="rh" class="tabcontent tab-box" style="display:none">
      <p><strong>Latest Humidity:</strong> <span id="humval">Loading...</span> %</p>
      <iframe src="https://thingspeak.com/channels/2960675/charts/6?dynamic=true&w=1000&h=400"></iframe>
    </div>
  </div>

  <!-- Merge + Analysis panel -->
  <div class="tab-box" style="margin-top:1rem">
    <h3 style="margin:.2rem 0 .6rem">Merged Table (GPS + Sensors) with Distance, Speed & AQI</h3>

    <div style="display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:.6rem;max-width:900px">
      <label>Channel ID
        <input id="mergeChId" value="2960675">
      </label>
      <label>Read API Key (optional)
        <input id="mergeReadKey" value="">
      </label>
      <label>Latest rows
        <input id="mergeResults" type="number" value="200">
      </label>
      <label>Merge window (sec)
        <input id="mergeWindow" type="number" value="90">
      </label>
    </div>

    <div style="margin:.6rem 0">
      <button id="mergeFetch" class="btn primary">Fetch & Merge</button>
      <button id="mergeDownload" class="btn" disabled>Download CSV</button>
      <span id="mergeStatus" class="muted" style="margin-left:.75rem">Waiting…</span>
    </div>

    <div style="overflow:auto; max-height:380px">
      <table id="mergeTable" style="width:100%;border-collapse:collapse;font-size:.95rem">
        <!-- filled by JS -->
      </table>
    </div>
  </div>
</section>

<script>
/* ===== Simple tab / dropdown helpers the section expects ===== */
function handleSensorSelect(v){
  const map = { scd30: 'co2', sps30: 'pm25', mics: 'pm10' };
  const tab = map[v] || 'co2';
  showTab(tab);
}
function showTab(id){
  document.querySelectorAll('#sensorTabs .tabcontent').forEach(el => el.style.display='none');
  const t = document.getElementById(id);
  if (t) t.style.display = '';
}

/* ===== Pull latest values just to fill the "Latest ..." spans ===== */
(async function fillLatest() {
  try {
    const r = await fetch('https://api.thingspeak.com/channels/2960675/feeds.json?results=1', {cache:'no-store'});
    if (!r.ok) return;
    const j = await r.json();
    const f = (j.feeds && j.feeds[0]) || {};
    const n = x => (x==null||x==='') ? '—' : (+x).toFixed(2);
    document.getElementById('co2val').textContent = f.field4 ? (+f.field4).toFixed(0) : '—';
    document.getElementById('pm25val').textContent = n(f.field2);
    document.getElementById('pm10val').textContent = n(f.field3);
    document.getElementById('pm1val').textContent  = n(f.field1);
    document.getElementById('tempval').textContent = n(f.field5);
    document.getElementById('humval').textContent  = n(f.field6);
  } catch {}
})();

/* ===== Merge + analysis ===== */
const mergeTable = document.getElementById('mergeTable');
const mergeStatus = document.getElementById('mergeStatus');
const dlBtn = document.getElementById('mergeDownload');

let lastMerged = [];
const COLS = [
  'created_at','pm1','pm25','pm10','co2','temp','hum',
  'lat','lon','dt_s',          // pairing lag
  'step_dt_s','step_dist_m','speed_kmh', // between consecutive merged rows
  'aqi'
];

function status(msg, cls='muted'){ mergeStatus.className = cls; mergeStatus.textContent = msg; }

async function readChannelFeeds(channelId, readKey, results=200){
  const u = new URL(`https://api.thingspeak.com/channels/${channelId}/feeds.json`);
  if (readKey) u.searchParams.set('api_key', readKey);
  u.searchParams.set('results', results);
  const r = await fetch(u.toString(), {cache:'no-store'});
  if (!r.ok) throw new Error(`TS read HTTP ${r.status}`);
  const j = await r.json();
  return j.feeds.map(f => ({
    created_at: f.created_at,
    ts: new Date(f.created_at).getTime(),
    pm1:   f.field1 ? parseFloat(f.field1) : null,
    pm25:  f.field2 ? parseFloat(f.field2) : null,
    pm10:  f.field3 ? parseFloat(f.field3) : null,
    co2:   f.field4 ? parseFloat(f.field4) : null,
    temp:  f.field5 ? parseFloat(f.field5) : null,
    hum:   f.field6 ? parseFloat(f.field6) : null,
    lat:   (f.field7!=null && f.field7!=='') ? parseFloat(f.field7) : NaN,
    lon:   (f.field8!=null && f.field8!=='') ? parseFloat(f.field8) : NaN
  }));
}
const isSensorRow = r => [r.pm1,r.pm25,r.pm10,r.co2,r.temp,r.hum]
  .some(v => typeof v === 'number' && !Number.isNaN(v));
const isGpsRow = r => Number.isFinite(r.lat) && Number.isFinite(r.lon);

// Haversine (meters)
function haversineMeters(lat1, lon1, lat2, lon2){
  const R = 6371000;
  const toRad = x => x * Math.PI/180;
  const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 +
            Math.cos(toRad(lat1))*Math.cos(toRad(lat2)) *
            Math.sin(dLon/2)**2;
  const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}

// US EPA-style AQI breakpoints (PM2.5 only here), returns 0-500 scale
function aqiFromPM25(pm){
  if (!Number.isFinite(pm)) return '';
  const bp = [
    {hi:12.0,  Ih:50,  Il:0,   Bh:12.0,  Bl:0.0},
    {hi:35.4,  Ih:100, Il:51,  Bh:35.4,  Bl:12.1},
    {hi:55.4,  Ih:150, Il:101, Bh:55.4,  Bl:35.5},
    {hi:150.4, Ih:200, Il:151, Bh:150.4, Bl:55.5},
    {hi:250.4, Ih:300, Il:201, Bh:250.4, Bl:150.5},
    {hi:350.4, Ih:400, Il:301, Bh:350.4, Bl:250.5},
    {hi:500.4, Ih:500, Il:401, Bh:500.4, Bl:350.5}
  ];
  for (const b of bp){
    if (pm <= b.hi){
      return Math.round((b.Ih - b.Il)/(b.Bh - b.Bl) * (pm - b.Bl) + b.Il);
    }
  }
  return 500;
}
// CO₂ comfort band (not an official AQI): 0–100 scaled where 100 is fresh air (~420 ppm)
function co2Score(co2){
  if (!Number.isFinite(co2)) return '';
  if (co2 <= 420) return 100;
  if (co2 >= 2000) return 0;
  // linear 420→2000 maps 100→0
  return Math.max(0, Math.round(100*(2000-co2)/(2000-420)));
}
// Combined index: PM2.5 AQI governs, CO₂ nudges by ± up to 20 points
function combinedAqi(pm25, co2){
  const aqi = aqiFromPM25(pm25);
  if (aqi === '') return '';
  const c = co2Score(co2);
  if (c === '') return aqi;
  // If CO₂ is poor (low score), bump AQI worse; if good, nudge better slightly
  const adjust = Math.round((50 - c/2) * 0.4); // range about -20..+20
  return Math.max(0, Math.min(500, aqi + adjust));
}

// Merge by nearest GPS within window; keep ONLY rows with a GPS match
function mergeSameChannel(rows, windowSec){
  const W = windowSec * 1000;
  const sensors = rows.filter(isSensorRow);
  const gps = rows.filter(isGpsRow);
  const out = [];
  for (const s of sensors){
    let best=null, bestDt=Infinity;
    for (const g of gps){
      const dt = Math.abs(s.ts - g.ts);
      if (dt < bestDt && dt <= W){ best=g; bestDt=dt; }
    }
    if (best){
      out.push({
        created_at: s.created_at,
        ts: s.ts,
        pm1: s.pm1 ?? '', pm25: s.pm25 ?? '', pm10: s.pm10 ?? '',
        co2: s.co2 ?? '', temp: s.temp ?? '', hum: s.hum ?? '',
        lat: best.lat, lon: best.lon,
        dt_s: Math.round(bestDt/1000)
      });
    }
  }
  // sort by time ascending
  out.sort((a,b)=>a.ts-b.ts);

  // add step distance/time/speed and AQI
  for (let i=0;i<out.length;i++){
    const r = out[i];
    const prev = out[i-1];
    if (prev){
      const step_dt_s = Math.max(1, Math.round((r.ts - prev.ts)/1000));
      const dist_m = haversineMeters(prev.lat, prev.lon, r.lat, r.lon);
      r.step_dt_s = step_dt_s;
      r.step_dist_m = Math.round(dist_m);
      r.speed_kmh = +( (dist_m/1000) / (step_dt_s/3600) ).toFixed(1);
    } else {
      r.step_dt_s = '';
      r.step_dist_m = '';
      r.speed_kmh = '';
    }
    r.aqi = combinedAqi(r.pm25, r.co2);
  }
  return out;
}

function renderTable(rows){
  if (!rows.length){
    mergeTable.innerHTML = '<tr><td>No merged rows with GPS in window.</td></tr>';
    return;
  }
  const thead = '<thead><tr>' + COLS.map(c=>`<th style="border:1px solid #e5e7eb;padding:.45rem .5rem;background:#f3f4f6">${c}</th>`).join('') + '</tr></thead>';
  const tbody = '<tbody>' + rows.map(r => {
    return '<tr>' + COLS.map(c => `<td style="border:1px solid #e5e7eb;padding:.45rem .5rem">${r[c] ?? ''}</td>`).join('') + '</tr>';
  }).join('') + '</tbody>';
  mergeTable.innerHTML = thead + tbody;

  const dts = rows.map(r=>r.dt_s).filter(v=>typeof v==='number');
  const steps = rows.map(r=>r.step_dt_s).filter(v=>typeof v==='number');
  if (dts.length){
    const avg = Math.round(dts.reduce((a,b)=>a+b,0)/dts.length);
    const min = Math.min(...dts), max = Math.max(...dts);
    status(`Done (${rows.length}). Δt(pair) [min=${min}s, avg=${avg}s, max=${max}s]`, 'ok');
  } else {
    status(`Done (${rows.length}).`, 'ok');
  }
  if (steps.length){
    const sAvg = Math.round(steps.reduce((a,b)=>a+b,0)/steps.length);
    status(mergeStatus.textContent + ` • Δt(step)≈${sAvg}s`, 'ok');
  }
}

function toCSV(rows){
  const head = COLS.join(',');
  const lines = rows.map(r => COLS.map(c => String(r[c] ?? '')).join(','));
  return [head, ...lines].join('\n');
}

document.getElementById('mergeFetch').addEventListener('click', async () => {
  const chId = document.getElementById('mergeChId').value.trim();
  const readKey = document.getElementById('mergeReadKey').value.trim();
  const results = Math.max(10, parseInt(document.getElementById('mergeResults').value || '200', 10));
  const windowSec = Math.max(5, parseInt(document.getElementById('mergeWindow').value || '90', 10));

  try {
    status('Fetching…');
    const rows = await readChannelFeeds(chId, readKey, results);
    status('Merging…');
    lastMerged = mergeSameChannel(rows, windowSec);
    renderTable(lastMerged);
    dlBtn.disabled = lastMerged.length === 0;
  } catch(e){
    status(`Error: ${e.message}`, 'err');
  }
});

dlBtn.addEventListener('click', () => {
  if (!lastMerged.length) return;
  const blob = new Blob([toCSV(lastMerged)], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'merged_with_distance_speed_aqi.csv';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});
</script>
