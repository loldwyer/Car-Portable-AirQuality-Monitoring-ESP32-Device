<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>GPS → ThingSpeak</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    #map { height: 400px; border-radius: 8px; margin-top: 10px; }
    .btn { padding: 0.6rem 1rem; margin: 0.3rem; border: none; border-radius: 6px; cursor: pointer; }
    .primary { background: #2563eb; color: white; }
    .ghost { background: #ccc; }
  </style>
</head>
<body>

<h1>GPS → ThingSpeak</h1>
<p>Status: <span id="status">Idle</span></p>
<button class="btn primary" id="startBtn">Start Upload</button>
<button class="btn ghost" id="stopBtn">Stop Upload</button>

<div id="map"></div>

<script>
const THINGSPEAK_API_KEY = "9YXHS30JF6Z9YHXI"; // <-- Replace with your Write API Key
const THINGSPEAK_UPDATE_URL = "https://api.thingspeak.com/update";

let map = L.map('map').setView([0, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);
let marker;

let gpsWatchId = null;
let sendTimer = null;

async function sendToThingSpeak(lat, lon) {
  try {
    let url = `${THINGSPEAK_UPDATE_URL}?api_key=${THINGSPEAK_API_KEY}&field7=${lat}&field8=${lon}`;
    let res = await fetch(url);
    let text = await res.text();
    if (text.trim() === "0") {
      document.getElementById("status").textContent = "ThingSpeak rejected update";
    } else {
      document.getElementById("status").textContent = `Uploaded: ${lat.toFixed(6)}, ${lon.toFixed(6)}`;
    }
  } catch (err) {
    console.error(err);
    document.getElementById("status").textContent = "Error uploading to ThingSpeak";
  }
}

document.getElementById("startBtn").addEventListener("click", () => {
  if (!navigator.geolocation) {
    alert("Geolocation not supported");
    return;
  }

  document.getElementById("status").textContent = "Starting GPS...";
  
  gpsWatchId = navigator.geolocation.watchPosition(pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;

    if (marker) marker.setLatLng([lat, lon]);
    else marker = L.marker([lat, lon]).addTo(map);
    map.setView([lat, lon], 16);

    // Send immediately
    sendToThingSpeak(lat, lon);

    // Send every 15 seconds
    if (!sendTimer) {
      sendTimer = setInterval(() => {
        sendToThingSpeak(lat, lon);
      }, 15000);
    }
  }, err => {
    console.error(err);
    document.getElementById("status").textContent = "GPS error";
  }, { enableHighAccuracy: true });
});

document.getElementById("stopBtn").addEventListener("click", () => {
  if (gpsWatchId) {
    navigator.geolocation.clearWatch(gpsWatchId);
    gpsWatchId = null;
  }
  if (sendTimer) {
    clearInterval(sendTimer);
    sendTimer = null;
  }
  document.getElementById("status").textContent = "Stopped";
});
</script>

</body>
</html>
