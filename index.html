<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>GPS to ESP32 + ThingSpeak</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    #map { height: 400px; border-radius: 8px; }
    .btn { padding: 0.6rem 1rem; margin: 0.3rem; border: none; border-radius: 6px; cursor: pointer; }
    .primary { background: #2563eb; color: white; }
    .warn { background: #f59e0b; color: white; }
    .ghost { background: #ccc; }
  </style>
</head>
<body>

<h1>GPS → ESP32 → ThingSpeak</h1>
<p>ESP32 IP: <strong id="espIp">10.229.188.187</strong></p>
<p>Status: <span id="status">Idle</span></p>
<button class="btn primary" id="startBtn">Start Test</button>
<button class="btn ghost" id="stopBtn">Stop Test</button>

<div id="map"></div>

<script>
const ESP32_IP = document.getElementById("espIp").textContent.trim();
const statusEl = document.getElementById("status");

let map = L.map('map').setView([0, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);
let marker;

let gpsWatchId = null;
let sendTimer = null;

// Send GPS to ESP32
async function sendLocation(lat, lon) {
  try {
    await fetch(`http://${ESP32_IP}/location`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ lat, lon })
    });
    statusEl.textContent = `Sent: ${lat.toFixed(6)}, ${lon.toFixed(6)}`;
  } catch (err) {
    console.error("Error sending location:", err);
    statusEl.textContent = "Error sending location";
  }
}

// Start GPS tracking
document.getElementById("startBtn").addEventListener("click", () => {
  if (!navigator.geolocation) {
    alert("Geolocation not supported");
    return;
  }

  statusEl.textContent = "Starting GPS...";
  
  gpsWatchId = navigator.geolocation.watchPosition(pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;

    if (marker) marker.setLatLng([lat, lon]);
    else marker = L.marker([lat, lon]).addTo(map);
    map.setView([lat, lon], 16);

    // Send immediately
    sendLocation(lat, lon);

    // Also send every 10 seconds
    if (!sendTimer) {
      sendTimer = setInterval(() => {
        sendLocation(lat, lon);
      }, 10000);
    }
  }, err => {
    console.error(err);
    statusEl.textContent = "GPS error";
  }, { enableHighAccuracy: true });
});

// Stop GPS tracking
document.getElementById("stopBtn").addEventListener("click", async () => {
  if (gpsWatchId) {
    navigator.geolocation.clearWatch(gpsWatchId);
    gpsWatchId = null;
  }
  if (sendTimer) {
    clearInterval(sendTimer);
    sendTimer = null;
  }

  // Tell ESP32 to stop using GPS
  try {
    await fetch(`http://${ESP32_IP}/stopLocation`, { method: "POST" });
    statusEl.textContent = "GPS stopped";
  } catch (err) {
    console.error("Error stopping GPS:", err);
  }
});
</script>

</body>
</html>
